# YourSQL: A High-Performance Database System Leveraging In-Storage Computing
[原文链接](https://dl.acm.org/doi/10.14778/2994509.2994512)

## 1.背景和动机
 1. Early filtering
为数据密集型查询快速交付最终结果是成功的数据仓库、商业智能和分析应用程序的关键。一种直观(且有效)的加速方法是减少通过存储网络传输到主机系统的数据量。这可以通过过滤无关的数据来实现,这就叫early filtering。
 2. 现有的实现方法没有充分利用现代固态存储设备技术，在成本效益和性能方面受到限制。
首先，软件过滤的前提是过滤像索引这样的元数据，但是元数据管理的开销可能非常大。因此，在硬盘框和数据库服务器之间采用高端的过滤服务器或fpga。但是，这样成本高，而且从存储设备传输的数据量保持不变，因为在被过滤之前，数据必须在任何情况下传输到过滤服务器或fpga。
3. 考虑到数据密集型操作的成本很大程度上是由I/O请求的数量驱动的，在查询处理的最早阶段减少I/O请求可以带来显著的性能改进。最新的ssd有足够的计算能力来处理不复杂的查询操作。
## 2.YOURSQL
论文探索了一种新颖的数据库系统架构，其中ssd提供计算能力，以实现更快的查询响应。
YourSQL，一种利用存储内计算(ISC)将查询卸载到ssd的数据库系统架构。
基于ISC在数据密集型、非复杂查询操作方面的独特功能，我们设计了一个支持ISC的数据库系统体系结构，命名为YourSQL。它保持传统数据库系统的架构基础不变，以方便实现并与现有系统兼容。下图展示了传统数据库和YOURSQL数据库的系统架构:
![在这里插入图片描述](https://img-blog.csdnimg.cn/b1f57c8c0d494c1cb2ebe3ff2f009d47.png)

查询引擎设置并执行查询计划，存储引擎处理来自查询引擎的I/O请求。虽然图1(b)中的YourSQL一般遵循传统系统的基本架构，但它进一步配备了支持ISC的ssd，整个软件栈通过ISC模块感知它们。
图2描述了如何使用启用了isc的SSD在sql中进行早期过滤。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20d8cf070f3d4e2db289f2dd6ceb52d6.png)

给定一个查询，查询引擎(1)解析它，(2)选择一个候选的早期过滤目标。然后，(3)它调用ISC采样器来估计对候选表进行早期过滤可能导致的I/O减少。(4)如果预期早期过滤有利，则将候选对象确定为早期过滤目标，并设置触发早期过滤的查询计划。(5)存储引擎调用ISC过滤器，而不是表扫描，以便对目标表进行早期过滤。当ISC过滤器的结果可用时(例如，相关页面的列表)，（6）主机根据检索到的结果执行ISC优化的读取(例如，批量预取)。
#### 基本设计
1. Target Table Selection and Join Order
在早期筛选方法中，联接顺序优化是一项艰巨的任务，因为选择要筛选的正确目标表和保证整体性能提高的正确联接顺序非常困难。
MySQL的方法相当简单。如果没有二级索引，则不会触发ICP。也就是说，没有索引，没有早期过滤。这严重限制了早期过滤在MySQL中的适用性。MySQL过于简化的目标选择标准，只是选择一个有预索引过滤器列的表，并不能总是保证I/O减少，因为I/O减少的数量取决于过滤比。
相反，YourSQL依赖于给定表的过滤比，并将估计的过滤比足够高的表作为早期过滤目标。
> 过滤比
> 从本质上说，这是一种页面级别的选择性，它表示页面集中相关页面的一部分。
> 过滤比高度依赖于过滤器谓词的存在，这些谓词通常作为'列运算符常量'形式的基本关系谓词出现
> 不需要任何先决条件，因此大大增强了适用性。

计算给定表的过滤率的简单方法是在扫描时计算符合条件的页面的数量，这必然会产生巨大的开销。为了选择一个预期具有最高过滤比和合理开销的表，YourSQL引入了两个指标，limiting score and estimated filtering ratio。
前者是通过简单的启发式计算的，因此产生的开销可以忽略不计。然而，它与过滤比没有定量的相关关系。
这个估计的过滤比与过滤比在数量上相关，因此评估潜在性能增益的准确性将进一步提高。
表的极限得分表示其筛选谓词的限制程度。因此，一个具有高极限分数的表可以被期望为一个具有高过滤比的表。
要计算给定表的极限得分，YourSQL会考虑过滤器谓词的数量、过滤器谓词中的操作类型以及表中的行数。过滤器谓词的操作类型限制更大，那么得分更高。
图3详细描述了YourSQL如何选择给定查询的早期过滤目标。
![在这里插入图片描述](https://img-blog.csdnimg.cn/afe48f1f12904416a40b8f39f1c6daca.png)

一旦设置了早期筛选目标，YourSQL将它放在连接顺序的前面，以便尽可能早地缩小中间行集。对于剩余的连接顺序，它遵循MySQL的决定。比较开启ICP的MySQL和YourSQL的查询计划，它们之间的本质区别是对第一个表的访问方法，即早期过滤目标。
2. Filtering Condition Pushdown
[谓词下推解释](https://zhuanlan.zhihu.com/p/554174896)
过滤条件下推(FCP)是针对sql使用过滤器谓词从表中检索行的情况进行的优化。根据存储引擎的请求，ISC过滤器根据目标表评估推送条件并存储匹配提示。
匹配提示是一个字节数组，如果相应的页面满足过滤条件，则将其元素设置为1。一旦开始，这些筛选器就会迭代早期筛选和积累匹配提示的过程，直到到达目标表的最后一页。
如图4所示，FCP中涉及两个ISC滤波器。
![在这里插入图片描述](https://img-blog.csdnimg.cn/2e04db8a29e3425facf8b55f2b13e84a.png)

这种专用硬件提供强大的过滤功能，可以显著减少跨存储网络的数据传输。尽管如此，硬件级别的数据相关性检查是有限的，因为根据过滤条件，硬件过滤的数据仍然可能包含假阳性。
根据筛选条件，硬件筛选器的匹配提示可以依次重定向到软件筛选器，这样，首先由硬件筛选器检查的数据的相关性可以进一步检查。
目标SSD中的硬件模式匹配器最多接受三个16字节二进制键，并执行字节粒度匹配。
3. Table Access based on Match Hints
一个早期可筛选查询将由三个任务处理:早期筛选、匹配页读取和行处理。如下图所示，通过这种并发处理(图5(b))而不是顺序处理(图5(a))， YourSQL有效地隐藏了早期过滤开销。
![在这里插入图片描述](https://img-blog.csdnimg.cn/d312eb9be5b54daabba5fdd3b52a8700.png)

YourSQL的存储引擎从过滤器中提取匹配提示，这些提示用于存储引擎的ISC-optimized的页面读取。因此，ISC筛选器确定的无关页面不会被传输到主机。
#### 优化
1. Sampling-driven FCP
在YourSQL中使用一个名为sampler的专用ISC任务来提供筛选比的定量估计。sampler扫描表的一小部分,通过sampler的过滤结果估计过滤比，即匹配页面数除以扫描页面数。如果估算的比率高于阈值，则启用FCP。关键就在于阈值该如何设置。
论文的分析表明，根据早期过滤目标的类型，查询可以分为四类。这四个查询分别是单个表查询、没有子查询的连接查询、带有派生表的查询以及带有单个或多个子查询的查询。
[派生表解释](https://zhuanlan.zhihu.com/p/64526488)
对于第一类，只要随机读取量低于整个表大小的30%，我们的目标系统中的异步随机读取操作就比顺序读取操作快。因此，阈值设为0.3；
对于第三类，我们简单地将阈值设置为1.0。派生表作为引用表，从中检索行。因此，通过早期过滤减少引用表的大小有望加速该类别中的查询。
对于第二和第四类，第二类和最后一类查询的阈值不能预先定义。相反，它们应该在运行中进行计算。目前，根据我们的目标系统性能和对这些类别中的TPCH查询的分析，我们根据经验确定这些阈值为0.7。后续可以构建一个精细化的成本模型来确定阈值。
2. Software Filtering
根据过滤条件，硬件过滤的数据仍然可能包含假阳性。这是由于执行字节粒度匹配的模式匹配程序的限制。所以引出了软件过滤进一步检查。软件过滤器是一个简单的ISC任务，由几个基本算术操作组成。
下图是它的伪代码：
![在这里插入图片描述](https://img-blog.csdnimg.cn/bb6ae86f69df4e029c67d10f6a5efc1b.png)

3. Highly Accurate Bulk Prefetch
匹配提示设置为1的页面将是回答给定查询所必需的页面的超集。预取它们肯定是非常有益的，因此YourSQL引入了两种预取技术。
 第一种技术是批量读取匹配页面。与单页读取相比，通过增加队列深度，批量读取有望获得明显更好的性能。
 第二种技术是主动预取。由于相对较高的内部带宽，ISC过滤器的处理时间比批量读取匹配页面的时间短。因此，在对当前单元中的页面进行批量读取期间，我们可以获得后续早期过滤单元的匹配提示。
 为此，我们创建了一个名为prefetcher的专用线程。图5(c)描述了包括预取器的查询执行流水线。
 预取器迭代提取匹配提示的过程，并批量为匹配页发出异步读请求。预取器通过单生产者/单消费者(SPSC)队列与存储引擎通信。为了避免它们之间的锁争用，这个队列被实现为一个简单的整数数组。当查询开始时，预取器为预取的页面分配内存空间。每次预取器提取匹配提示时，与之对应的匹配页将被批量读取并放入SPSC队列中。然后，存储引擎根据需要将预取的页面从队列中解队列。
 
 ## 3.实验评估
 1. 系统设置
我们在一个由戴尔PowerEdge R720服务器和三星PM1725(如图6所示的最新企业级NVMe SSD)组成的系统上进行了实验。服务器搭载2台Intel Xeon(R) CPU E5-2640 @2.50GHz和64GB DRAM，运行64位Ubuntu 15.04。SSD卡通过PCIe Gen3 ×4与服务器连接。
![在这里插入图片描述](https://img-blog.csdnimg.cn/b036877efd294133883e032013711d42.png)

SSD的详细信息：
![在这里插入图片描述](https://img-blog.csdnimg.cn/f09e441357014ab0ab51cfc73a9afbf0.png)

作为基线系统，我们选择了MySQL的增强分支MariaDB的5.5.42版本。
主要的工作负载：TPC-H，[TPC-H的介绍](https://zhuanlan.zhihu.com/p/566024607)
比例因子为100，表示表的数据量是100GB。
 2. 评估结果
- Selection Query
对于最初的YourSQL性能评估，我们使用一个相当简单的综合查询，即查询1。它的过滤器谓词非常严格，以至于硬件过滤器可以过滤掉所有不必要的页面。
![在这里插入图片描述](https://img-blog.csdnimg.cn/848a14f045fa475c960203c46d42134d.png)
![在这里插入图片描述](https://img-blog.csdnimg.cn/3c4c20d0b2a840cd9e166cfb5293b5ec.png)

如表4所示，执行时间减少了七分之一，即使用YourSQL的速度提高了7倍。
- Join Query
为了评估它在连接查询方面的潜在收益，我们使用TPC-H Q2(参见查询2)。如表5所示，执行时间减少了44倍，甚至与table4中显示的速度相比，这是一个大幅的提高。
![在这里插入图片描述](https://img-blog.csdnimg.cn/86a69f5926524809b92b6f1215f4ea0f.png)
![在这里插入图片描述](https://img-blog.csdnimg.cn/0dcbb4c744024776b01bc8d6c7044837.png)

通过将早期过滤目标放在连接顺序的首位(例如，查询中的部分表)，我们的系统减少了在查询处理的初始阶段必须读取和处理的行数。然而，需要注意的是，对于连接查询，FCP的这种性能改进并不总是得到保证。与单个表查询相比，有各种因素会影响连接查询的I/O操作的数量。

- Available Memory Size
由于缓冲区大小是数据库系统中的一个关键性能因素，我们研究了它对查询性能的影响。我们测量了将系统内存大小从默认的16 GiB更改为8 GiB (0.5×)、32 GiB (2×)和64 GiB (4×)后的相应加速。
![在这里插入图片描述](https://img-blog.csdnimg.cn/0b1aefcb0c8a41239cc3a4083dd71249.png)

这种趋势意味着MySQL比YourSQL从更大的缓冲区中获益更多，这是意料之中的，因为更大的缓冲区会使读I/O的相对成本降低，因此其减少的影响也会更小。
- TPC-H Results
对于22个TPC-H查询中的每一个，我们测量了它的执行时间和数据传输减少的比例。后者是在使用MySQL查询时，通过存储网络传输的数据量与使用YourSQL查询时的数据量之比。这个比率，$α_{saving}$，定量地说明了在YourSQL中由于FCP而被传输的数据的数量。
![在这里插入图片描述](https://img-blog.csdnimg.cn/e06411c420204429ac2934387793078f.png)

禁用FCP后，其余14个查询的相对性能是统一的。
作为异构查询(即不同的表访问次数和顺序，不同的名义执行时间，等等)的平均加速平均值，前五个加速查询以及所有查询的几何平均值分别在Q9和Q22旁边给出。
[几何平均数](https://zhuanlan.zhihu.com/p/23809612)
减少的数据传输比例如图8的顶部面板所示，这与预期的加速结果高度相关。
- Optimizations
为了衡量3.2节中介绍的优化技术的效果，我们反复运行在不同优化方案下性能提高最大的前5个查询。
![在这里插入图片描述](https://img-blog.csdnimg.cn/4aae6fae85de4324bac121cb84055ecc.png)

图9给出了不同优化方案下YourSQL的加速情况。
![在这里插入图片描述](https://img-blog.csdnimg.cn/d4df809d69074376ba8d1234addbf7d1.png)

在Opt-PSH中看到的最大改进意味着主机端读操作是加速总体性能的限制因素。因此，当使用HABP优化主机端读操作时，获得的收益最大。
我们看到，在某些情况下(Q10和Q8)，启用icp的MySQL优于完全优化的YourSQL。这是因为，尽管MySQL基于索引的页面查找非常准确，但根据过滤条件的不同，经过icp筛选的数据仍然可能包含假阳性。
然而，考虑到具有ICP的MySQL需要对表进行预处理(在运行每个查询之前创建所需的二级索引)，这没有包括在执行时间的测量中，每个查询中最大的加速仍然是在YourSQL中实现的。
- Power Consumption
我们测量了TPC-H Q2加工过程中的能耗。
![在这里插入图片描述](https://img-blog.csdnimg.cn/60da068be6744e449bad984f427013d8.png)

YourSQL在给定的时间间隔内消耗更多的能量，因为它更充分地利用了目标SSD的带宽能力。
在查询结束之后，功耗仍然会持续。我们认为这种剩余功耗来自于查询后处理，如同步缓冲区。
表7将图10中随时间的功耗集成到整体能耗中。  
![在这里插入图片描述](https://img-blog.csdnimg.cn/68c0f69bbdde4d85a8254cf1e950b6a4.png)

- Queries on Column Store
为了验证YourSQL中早期的过滤方法对面向列的数据库系统(即列存储)是否也有效，我们在列存储上设计了一个微基准测试，并使用Query 1运行它。为了创建列存储，我们将TPC-H数据集的每个原始表文件划分为段。序列化单个列的所有值的每个段与行标识号(行id)一起作为一个具有4K对齐的独立文件存储。
我们评估了列式压缩和无列式压缩的潜在收益。压缩是通过只存储一次重复的列值和匹配的行id来完成的。
![在这里插入图片描述](https://img-blog.csdnimg.cn/0cd338aa84b8450389040e506ab20eab.png)

两个文件中的过滤比率是统一的，但由于压缩时的数据局部性(例如，2%和20%)，过滤比率显著降低。很明显，从尽可能低的过滤比来看（如1），早期过滤在原始列存储中一定是无效的。
我们在原始列存储和压缩列存储上运行有和没有早期过滤的微基准测试。
在原始列存储下不再需要全面扫描(即没有早期过滤)，因为当列值满足过滤条件(即p size = 15)时，它就停止扫描。
图11显示了最终的执行时间。直方图上方的值表示实现的加速。
![在这里插入图片描述](https://img-blog.csdnimg.cn/d02221c0ba454389bf54d8a38d3f7865.png)

根据这些结果可以得出两个重要的结论。首先，由于较低的过滤比，早期过滤方法很难在没有压缩(或数据局部性较低)的列存储中受益。其次，数据结构(即行与列和/或原始与压缩)是决定早期过滤有效性及其程度的一个重要因素。

## 4.总结
本文描述了建立在最先进的SSD架构之上的数据库系统YourSQL。通过实现跨越主机系统和SSD的端到端数据路径优化，论文追求实现成本效益和高性能的数据分析。据作者所知，这是第一个建立在商用NVMe ssd上ISC概念上的产品强度数据库系统。此外，论文的原型系统证明，在ssd中附加的近数据计算资源的帮助下，可以加速全表扫描。
